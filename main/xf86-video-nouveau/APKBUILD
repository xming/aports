# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=xf86-video-nouveau
#_gitdate=20111010
pkgver=1.0.11_git20150913
_ver=${pkgver%_git*}
pkgrel=0
pkgdesc="Open-source X.org drivers for nVidia video cards"
url="http://nouveau.freedesktop.org/"
arch="all"
license="MIT"
depends="mesa-dri-nouveau"
depends_dev=
makedepends="randrproto renderproto videoproto xextproto libdrm-dev
	xorg-server-dev util-macros libtool autoconf automake xf86driproto
	eudev-dev
	automake autoconf libtool"
install=""
subpackages="$pkgname-doc"
source="http://xorg.freedesktop.org/releases/individual/driver/xf86-video-nouveau-${_ver}.tar.bz2
	git.patch
	"

_builddir="$srcdir"/xf86-video-nouveau-$_ver

mksource() {
	mkdir /tmp/${pkgname}-${_gitdate}
	(cd /tmp/${pkgname}-${_gitdate};
	git clone -v --depth 1 git://anongit.freedesktop.org/nouveau/xf86-video-nouveau;
	cd xf86-video-nouveau;
	git archive --prefix=xf86-video-nouveau-${_gitdate}/ --format=tar HEAD | bzip2 > /tmp/${pkgname}-${_gitdate}/${pkgname}-${_gitdate}.tar.bz2)
}

prepare() {
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
	autoreconf -vif
}

build() {
	cd "$_builddir"
	export LDFLAGS="$LDFLAGS -Wl,-z,lazy"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		|| return 1
	make || return 1
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install || return 1
}

md5sums="a0d2932d84ba10c4933c8332c9afe157  xf86-video-nouveau-1.0.11.tar.bz2
93561d95226bc2d5ea811f4277424f43  git.patch"
sha256sums="f84fe2b2787f3ea9419eac3aa86462b929a551b3dbc4de550cc83b67f3216848  xf86-video-nouveau-1.0.11.tar.bz2
c90d9643179d589300a45ac6fe330c44dc46faf382f0e646a8eff0791f53e903  git.patch"
sha512sums="4ceffc711798b98a5ee67d9df33d1a4f1d2b7d100605ea04b2e689debf745bc5a4f8907b602d1689ec6ed6400b2fc0ffe0eb0f7e7787bd2dd3cd5db1d14e90ee  xf86-video-nouveau-1.0.11.tar.bz2
3ec5d839d0591f1c8525b661dc195b873bd9a992ce10000afeebdec37849b19a14e4230f4230286efa7753e5c5b86968e7a560268ca55af5d70b9f37e929be75  git.patch"
